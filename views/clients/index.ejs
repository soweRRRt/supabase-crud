<%- include('../partials/header', { title: "Клиенты", user }) %>

<div class="container py-5">
  <h1 class="mb-4">Клиенты</h1>

  <!-- Форма фильтров -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Фильтры поиска</h5>
    </div>
    <div class="card-body">
      <form method="GET" action="/clients" class="row g-3">
        <div class="col-md-4">
          <label for="search" class="form-label">ФИО</label>
          <input 
            type="text" 
            class="form-control" 
            id="search" 
            name="search" 
            value="<%= filters.search || '' %>"
            placeholder="Введите ФИО..."
          >
        </div>

        <div class="col-md-3">
          <label for="status" class="form-label">Статус</label>
          <select class="form-select" id="status" name="status">
            <option value="all">Все статусы</option>
            <% statuses.forEach(s => { %>
              <option 
                value="<%= s.id %>" 
                <%= filters.status == s.id ? 'selected' : '' %>>
                <%= s.name %>
              </option>
            <% }) %>
          </select>
        </div>

        <div class="col-md-3">
          <label for="phone" class="form-label">Номер телефона</label>
          <input 
            type="text" 
            class="form-control" 
            id="phone" 
            name="phone" 
            value="<%= filters.phone || '' %>"
            placeholder="Введите номер..."
          >
        </div>

        <div class="col-md-2 d-flex align-items-end">
          <div class="btn-group w-100">
            <button type="submit" class="btn btn-primary">Поиск</button>
            <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">Сбросить</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <a class="btn btn-success mb-3" href="/clients/new">Добавить нового клиента</a>

  <div class="table-responsive shadow-sm">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th onclick="sortTable('full_name')" style="cursor:pointer;">ФИО <script>document.write(getSortIcon('full_name'))</script></th>
          <th onclick="sortTable('phone_number')" style="cursor:pointer;">Номер телефона <script>document.write(getSortIcon('phone_number'))</script></th>
          <th onclick="sortTable('status')" style="cursor:pointer;">Статус <script>document.write(getSortIcon('status'))</script></th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
        <% if (clients.length === 0) { %>
          <tr><td colspan="4" class="text-center text-muted">Клиенты не найдены</td></tr>
        <% } else { %>
          <% clients.forEach(c => { %>
            <tr>
              <td><%= c.full_name %></td>
              <td><%= c.phone_number %></td>
              <td><%= c.client_status ? c.client_status.name : 'Не указан' %></td>
              <td>
                <a class="btn btn-sm btn-warning" href="/clients/<%= c.id %>/edit">Изменить</a>
                <form action="/clients/<%= c.id %>?_method=DELETE" method="POST" class="d-inline" onsubmit="event.preventDefault(); confirmDelete(this);">
                  <button class="btn btn-sm btn-danger" type="submit">Удалить</button>
                </form>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>

  <% if (filters.search || filters.status || filters.phone || filters.sort_by) { %>
    <div class="mt-3">
      <small class="text-muted">
        Активные фильтры:
        <% if (filters.search) { %> ФИО: "<%= filters.search %>" <% } %>
        <% if (filters.status && filters.status !== 'all') { %> 
          <% const statusObj = statuses.find(s => s.id == filters.status); %>
          <% if (statusObj) { %> | Статус: <%= statusObj.name %> <% } %>
        <% } %>
        <% if (filters.phone) { %> | Телефон: "<%= filters.phone %>" <% } %>
        <% if (filters.sort_by) { %> | Сортировка по: <%= filters.sort_by %> (<%= filters.sort_order === 'desc' ? 'убыванию' : 'возрастанию' %>) <% } %>
      </small>
    </div>
  <% } %>
</div>

<%- include('../partials/footer') %>
