<%- include('../partials/header', { title: "–ö–ª–∏–µ–Ω—Ç—ã", user }) %>

<div class="container py-5">
  <h1 class="mb-4">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤</h1>

  <!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">–§–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</h5>
    </div>
    <div class="card-body">
      <form method="GET" action="/clients" class="row g-3">
        <!-- –§–ò–û -->
        <div class="col-md-4">
          <label for="search" class="form-label">–§–ò–û</label>
          <div class="input-group">
            <input list="clientNames" type="text" class="form-control" id="search" name="search" value="<%= filters.search || '' %>" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û..." autocomplete="off" oninput="toggleClearButton('searchBtn', this)">
            <button class="btn btn-outline-secondary" type="button" id="searchBtn" onclick="document.getElementById('search').value=''; toggleClearButton('searchBtn', document.getElementById('search'));">√ó</button>
          </div>
          <datalist id="clientNames">
            <% clients.forEach(c => { %>
              <option value="<%= c.full_name %>"></option>
            <% }) %>
          </datalist>
        </div>

        <!-- –°—Ç–∞—Ç—É—Å -->
        <div class="col-md-3">
          <label for="status" class="form-label">–°—Ç–∞—Ç—É—Å</label>
          <select class="form-select" id="status" name="status">
            <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            <% statuses.forEach(s => { %>
              <option value="<%= s.id %>" <%= filters.status == s.id ? 'selected' : '' %>><%= s.name %></option>
            <% }) %>
          </select>
        </div>

        <!-- –¢–µ–ª–µ—Ñ–æ–Ω -->
        <div class="col-md-3">
          <label for="phone" class="form-label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
          <div class="input-group">
            <input list="clientPhones" type="text" class="form-control" id="phone" name="phone" value="<%= filters.phone || '' %>" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä..." autocomplete="off" oninput="toggleClearButton('phoneBtn', this)">
            <button class="btn btn-outline-secondary" type="button" id="phoneBtn" onclick="document.getElementById('phone').value=''; toggleClearButton('phoneBtn', document.getElementById('phone'));">√ó</button>
          </div>
          <datalist id="clientPhones">
            <% clients.forEach(c => { %>
              <option value="<%= c.phone_number %>"></option>
            <% }) %>
          </datalist>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="col-md-2 d-flex align-items-end">
          <div class="btn-group w-100">
            <button type="submit" class="btn btn-primary">–ü–æ–∏—Å–∫</button>
            <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <a class="btn btn-outline-success" onclick="exportToExcel()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</a>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>–§–ò–û</th>
          <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody>
        <% clients.forEach(c => { %>
          <tr>
            <td><%= c.full_name %></td>
            <td><%= c.phone_number %></td>
            <td><%= c.client_status?.name || '–ù–µ —É–∫–∞–∑–∞–Ω' %></td>
            <td>
              <a href="/clients/<%= c.id %>/edit" class="btn btn-sm btn-primary">‚úèÔ∏è</a>
              <form action="/clients/<%= c.id %>?_method=DELETE" method="POST" class="d-inline">
                <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è</button>
              </form>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
function toggleClearButton(btnId, inputEl) {
  document.getElementById(btnId).style.display = inputEl.value ? 'inline-block' : 'none';
}

function resetFilters() {
  document.getElementById('search').value = '';
  document.getElementById('status').value = 'all';
  document.getElementById('phone').value = '';
  document.querySelector('form').submit();
}

async function exportToExcel() {
  const params = new URLSearchParams(window.location.search);
  const response = await fetch('/clients/export?' + params.toString());
  const clients = await response.json();

  const wsData = [['–§–ò–û', '–¢–µ–ª–µ—Ñ–æ–Ω', '–°—Ç–∞—Ç—É—Å']];
  clients.forEach(c => wsData.push([c.full_name, c.phone_number, c.client_status?.name || '–ù–µ —É–∫–∞–∑–∞–Ω']));

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, '–ö–ª–∏–µ–Ω—Ç—ã');
  XLSX.writeFile(wb, 'clients.xlsx');
}
</script>

<%- include('../partials/footer') %>
